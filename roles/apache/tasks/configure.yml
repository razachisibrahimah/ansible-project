---
# Configure Apache for single and proxy backend mode with idempotency

# Decide which port Apache should listen on:
#  Single mode: apache_port        (APACHE_PORT from .env)
#  Proxy mode: apache_backend_port (APACHE_BACKEND_PORT or overridden in playbook)
- name: Set effective Apache port
  set_fact:
    apache_effective_port: "{{ apache_backend_port | default(apache_port) }}"

- name: Debug Apache mode and port
  debug:
    msg:
      - "Apache mode: {{ mode | default('UNKNOWN') }}"
      - "Apache server var: {{ server | default('UNKNOWN') }}"
      - "Apache effective port: {{ apache_effective_port }}"

# ---------------------------------------------------------
# STOP NGINX ONLY IN SINGLE APACHE MODE
# ---------------------------------------------------------
- name: Disable Nginx in Apache-only mode (safe)
  become: yes
  service:
    name: nginx
    state: stopped
    enabled: no
  when: mode == 'single' and server == 'apache'
  ignore_errors: yes

# ---------------------------------------------------------
# Ensure document root exists
# ---------------------------------------------------------
- name: Ensure Apache document root exists
  become: yes
  file:
    path: "{{ web_dir }}"
    state: directory
    mode: "0755"

# ---------------------------------------------------------
# Deploy ports.conf: Apache listens ONLY on apache_effective_port
# ---------------------------------------------------------
- name: Deploy ports.conf
  become: yes
  template:
    src: ports.conf.j2
    dest: /etc/apache2/ports.conf
    mode: "0644"
  notify: reload apache

# ---------------------------------------------------------
# Deploy vhost config (000-default.conf)
# Uses apache_effective_port for BOTH single and proxy
#   Single: *:80
#   Proxy:  *:8080
# ---------------------------------------------------------
- name: Deploy 000-default.conf
  become: yes
  template:
    src: 000-default.conf.j2
    dest: /etc/apache2/sites-available/000-default.conf
    mode: "0644"
  notify: reload apache

# ---------------------------------------------------------
# Ensure default vhost is enabled in ALL modes
# (it already uses apache_effective_port from the template)
# ---------------------------------------------------------
- name: Ensure Apache default site is enabled
  become: yes
  file:
    src: /etc/apache2/sites-available/000-default.conf
    path: /etc/apache2/sites-enabled/000-default.conf
    state: link

# ---------------------------------------------------------
# Ensure Apache service is running on the correct port
# ---------------------------------------------------------
- name: Ensure Apache service is running and enabled
  become: yes
  service:
    name: apache2
    state: started
    enabled: yes

# ---------------------------------------------------------
# Deploy index.html
#    In single mode: user-facing test page
#    In proxy mode: backend page (should NOT conflict with Nginx)
# ---------------------------------------------------------
- name: Deploy Apache index.html
  become: yes
  template:
    src: index.html.j2
    dest: "{{ web_dir }}/index.html"
    mode: "0644"
  notify: reload apache
