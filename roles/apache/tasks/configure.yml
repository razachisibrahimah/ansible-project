---
# Configure Apache for single and proxy backend mode with idempotency

- name: Set effective Apache port
  set_fact:
    apache_effective_port: "{{ apache_backend_port | default(apache_port) }}"

# ---------------------------------------------------------
# STOP NGINX ONLY IN SINGLE APACHE MODE (idempotent)
# ---------------------------------------------------------
- name: Disable Nginx in Apache-only mode (safe)
  become: yes
  service:
    name: nginx
    state: stopped
    enabled: no
  when: mode == 'single' and server == 'apache'
  ignore_errors: yes

# ---------------------------------------------------------
# Ensure document root exists
# ---------------------------------------------------------
- name: Ensure Apache document root exists
  become: yes
  file:
    path: "{{ web_dir }}"
    state: directory
    mode: "0755"

# ---------------------------------------------------------
# Deploy ports.conf (idempotent template)
# ---------------------------------------------------------
- name: Deploy ports.conf
  become: yes
  template:
    src: ports.conf.j2
    dest: /etc/apache2/ports.conf
    mode: "0644"
  notify: reload apache

# ---------------------------------------------------------
# Deploy vhost config (idempotent template)
# ---------------------------------------------------------
- name: Deploy 000-default.conf
  become: yes
  template:
    src: 000-default.conf.j2
    dest: /etc/apache2/sites-available/000-default.conf
    mode: "0644"
  notify: reload apache

# ---------------------------------------------------------
# Ensure vhost symlink exists
# ---------------------------------------------------------
- name: Ensure Apache default site is enabled
  become: yes
  file:
    src: /etc/apache2/sites-available/000-default.conf
    path: /etc/apache2/sites-enabled/000-default.conf
    state: link

# ---------------------------------------------------------
# Ensure Apache running
# ---------------------------------------------------------
- name: Ensure Apache service is running and enabled
  become: yes
  service:
    name: apache2
    state: started
    enabled: yes

# ---------------------------------------------------------
# Deploy index.html (idempotent)
# ---------------------------------------------------------
- name: Deploy Apache index.html
  become: yes
  template:
    src: index.html.j2
    dest: "{{ web_dir }}/index.html"
    mode: "0644"
  notify: reload apache
