---
# Configure Apache for single mode (apache-only) or proxy backend mode

- name: Set effective Apache port
  set_fact:
    apache_effective_port: "{{ apache_backend_port | default(apache_port) }}"

# ---------------------------------------------------------
#  STRICT RESET OF NGINX IN APACHE-ONLY MODE
# ---------------------------------------------------------
- name: Stop and disable Nginx in Apache-only mode
  become: yes
  service:
    name: nginx
    state: stopped
    enabled: no
  when: mode == 'single' and server == 'apache'
  ignore_errors: yes

# ---------------------------------------------------------
#  Ensure document root exists
# ---------------------------------------------------------
- name: Ensure Apache document root exists
  become: yes
  file:
    path: "{{ web_dir }}"
    state: directory
    mode: "0755"

# ---------------------------------------------------------
#  Manage ports.conf via template (no stale Listen 80)
# ---------------------------------------------------------
- name: Deploy Apache ports.conf
  become: yes
  template:
    src: ports.conf.j2
    dest: /etc/apache2/ports.conf
    mode: "0644"
  notify: restart apache

# ---------------------------------------------------------
#  Manage default vhost as template
# ---------------------------------------------------------
- name: Deploy Apache default vhost
  become: yes
  template:
    src: 000-default.conf.j2
    dest: /etc/apache2/sites-available/000-default.conf
    mode: "0644"
  notify: restart apache

- name: Ensure Apache default site is enabled
  become: yes
  file:
    src: /etc/apache2/sites-available/000-default.conf
    path: /etc/apache2/sites-enabled/000-default.conf
    state: link
  notify: reload apache

# ---------------------------------------------------------
#  Ensure Apache running on the correct port
# ---------------------------------------------------------
- name: Ensure Apache service is running and enabled
  become: yes
  service:
    name: apache2
    state: started
    enabled: yes

# ---------------------------------------------------------
#  Deploy index.html via template
# ---------------------------------------------------------
- name: Deploy Apache index.html
  become: yes
  template:
    src: index.html.j2
    dest: "{{ web_dir }}/index.html"
    mode: "0644"
  notify: reload apache
