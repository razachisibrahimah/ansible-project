---
# ---------------------------------------------------------
# NGINX PACKAGE
# ---------------------------------------------------------

- name: Ensure Nginx is installed
  apt:
    name: nginx
    state: present
    update_cache: yes

# ---------------------------------------------------------
# STOP APACHE WHEN USING SINGLE NGINX MODE
# ---------------------------------------------------------
- name: Stop Apache when in Nginx-only mode
  service:
    name: apache2
    state: stopped
    enabled: no
  when: mode == "single" and server == "nginx"
  ignore_errors: yes

# ---------------------------------------------------------
# DOCUMENT ROOT
# ---------------------------------------------------------
- name: Ensure Nginx document root exists
  file:
    path: "{{ nginx_web_root }}"
    state: directory
    mode: "0755"

# ---------------------------------------------------------
# PROXY MODE TEMPLATE
# ---------------------------------------------------------
- name: Deploy Nginx reverse proxy config (proxy mode)
  template:
    src: "{{ nginx_reverse_proxy_conf }}.j2"
    dest: /etc/nginx/sites-available/{{ nginx_reverse_proxy_conf }}
    mode: "0644"
  when: mode == "proxy"
  notify: reload nginx

- name: Enable reverse proxy config
  file:
    src: /etc/nginx/sites-available/{{ nginx_reverse_proxy_conf }}
    path: /etc/nginx/sites-enabled/{{ nginx_reverse_proxy_conf }}
    state: link
  when: mode == "proxy"
  notify: reload nginx

- name: Disable default site in proxy mode
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  when: mode == "proxy"
  notify: reload nginx

# ---------------------------------------------------------
# SINGLE MODE TEMPLATE
# ---------------------------------------------------------
- name: Deploy Nginx default config (single mode)
  template:
    src: "{{ nginx_default_conf }}.j2"
    dest: /etc/nginx/sites-available/default
    mode: "0644"
  when: mode == "single" and server == "nginx"
  notify: reload nginx

- name: Ensure default site enabled (single mode)
  file:
    src: /etc/nginx/sites-available/default
    path: /etc/nginx/sites-enabled/default
    state: link
  when: mode == "single" and server == "nginx"
  notify: reload nginx

# ---------------------------------------------------------
# INDEX PAGE
# ---------------------------------------------------------
- name: Deploy index.html only in single Nginx mode
  template:
    src: index.html.j2
    dest: "{{ nginx_web_root }}/index.html"
    mode: "0644"
  when: mode == "single" and server == "nginx"
  notify: reload nginx

# ---------------------------------------------------------
# SERVICE
# ---------------------------------------------------------
- name: Ensure Nginx is running and enabled
  service:
    name: nginx
    state: started
    enabled: yes
